<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Cadastro de Profissional ‚Äî SublocaF√°cil</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>
<style>
:root {
  --green:   #0a7c5c;
  --green-l: #10b981;
  --green-xl:#d1fae5;
  --ink:     #1a2332;
  --muted:   #6b7a94;
  --border:  #e2e8f2;
  --bg:      #f6f8fc;
  --white:   #ffffff;
  --danger:  #dc2626;
  --warn:    #d97706;
  --radius:  14px;
  --font-h:  'Lora', Georgia, serif;
  --font-b:  'DM Sans', system-ui, sans-serif;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:var(--font-b); background:var(--bg); color:var(--ink); font-size:14px; }

/* HERO */
.hero {
  background: linear-gradient(135deg, #0d1117 0%, #0a2e1f 100%);
  padding: 40px 24px 60px;
  text-align: center;
  position: relative;
  overflow: hidden;
}
.hero::before {
  content:'';position:absolute;width:600px;height:600px;border-radius:50%;
  background:radial-gradient(circle,rgba(16,185,129,.12) 0%,transparent 70%);
  top:-200px;left:50%;transform:translateX(-50%);pointer-events:none;
}
.hero-clinic-name {
  display:inline-flex;align-items:center;gap:8px;
  background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.2);
  border-radius:20px;padding:6px 16px;
  font-size:13px;font-weight:600;color:var(--green-l);
  margin-bottom:20px;
}
.hero h1 {
  font-family:var(--font-h);font-size:clamp(28px,5vw,44px);
  color:white;line-height:1.2;margin-bottom:12px;
}
.hero h1 em { font-style:italic;color:var(--green-l); }
.hero p { color:rgba(255,255,255,.6);font-size:15px;max-width:480px;margin:0 auto; }

/* STEPS */
.steps-bar {
  background:white;border-bottom:1px solid var(--border);
  padding:16px 24px;display:flex;justify-content:center;gap:0;
  position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,.06);
}
.step {
  display:flex;align-items:center;gap:8px;padding:0 16px;
  font-size:12px;font-weight:600;color:var(--muted);
}
.step-num {
  width:24px;height:24px;border-radius:50%;
  border:2px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;
}
.step.active .step-num { background:var(--green);border-color:var(--green);color:white; }
.step.active { color:var(--green); }
.step.done .step-num { background:var(--green-xl);border-color:var(--green-l);color:var(--green); }
.step-sep { width:32px;height:1px;background:var(--border); }

/* CONTAINER */
.wrap { max-width:720px;margin:0 auto;padding:32px 20px 60px; }

/* SCREEN */
.screen { display:none; }
.screen.active { display:block; }

/* SECTION TITLE */
.sec-title { font-family:var(--font-h);font-size:22px;margin-bottom:4px; }
.sec-sub { color:var(--muted);font-size:13px;margin-bottom:24px; }

/* FIELD */
.field { margin-bottom:16px; }
.field label {
  display:block;font-size:12px;font-weight:700;
  text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-bottom:6px;
}
.field input,.field select,.field textarea {
  width:100%;padding:11px 14px;
  border:1.5px solid var(--border);border-radius:10px;
  font-family:var(--font-b);font-size:14px;color:var(--ink);
  background:white;outline:none;transition:border-color .2s;
}
.field input:focus,.field select:focus { border-color:var(--green-l);box-shadow:0 0 0 3px rgba(16,185,129,.1); }
.field-row { display:grid;grid-template-columns:1fr 1fr;gap:12px; }
.field-row .field { margin-bottom:0; }

/* CARD */
.card {
  background:white;border:1px solid var(--border);
  border-radius:var(--radius);padding:24px;
  box-shadow:0 1px 4px rgba(0,0,0,.06);margin-bottom:16px;
}
.card-title { font-size:15px;font-weight:700;margin-bottom:4px; }
.card-sub   { font-size:12px;color:var(--muted);margin-bottom:16px; }

/* TIPO SUBLOCACAO */
.tipo-grid { display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px; }
.tipo-card {
  border:2px solid var(--border);border-radius:var(--radius);
  padding:20px;cursor:pointer;transition:all .2s;
}
.tipo-card:hover { border-color:var(--green-l); }
.tipo-card.selected { border-color:var(--green);background:var(--green-xl); }
.tipo-icon { font-size:24px;margin-bottom:8px; }
.tipo-name { font-weight:700;font-size:15px;margin-bottom:4px; }
.tipo-desc { font-size:12px;color:var(--muted); }
.tipo-price { font-size:18px;font-weight:700;color:var(--green);margin-top:8px; }

/* HORARIOS GRID */
.dias-grid { display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-bottom:16px; }
.dia-btn {
  padding:8px 4px;border:1.5px solid var(--border);border-radius:8px;
  background:white;font-family:var(--font-b);font-size:11px;font-weight:700;
  color:var(--muted);cursor:pointer;text-align:center;transition:all .15s;
}
.dia-btn.selected { background:var(--green);border-color:var(--green);color:white; }

.horas-grid { display:grid;grid-template-columns:repeat(auto-fill,minmax(72px,1fr));gap:6px; }
.hora-btn {
  padding:8px;border:1.5px solid var(--border);border-radius:8px;
  background:white;font-family:var(--font-b);font-size:12px;font-weight:600;
  color:var(--muted);cursor:pointer;text-align:center;transition:all .15s;
}
.hora-btn.selected { background:var(--green);border-color:var(--green);color:white; }
.hora-btn.ocupado  { background:var(--bg);color:var(--border);cursor:not-allowed;text-decoration:line-through; }

/* RESUMO */
.resumo-box {
  background:linear-gradient(135deg,var(--ink),#0a2e1f);
  border-radius:var(--radius);padding:24px;color:white;margin-bottom:16px;
}
.resumo-row { display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.1); }
.resumo-row:last-child { border:none; }
.resumo-label { font-size:13px;color:rgba(255,255,255,.6); }
.resumo-val   { font-size:14px;font-weight:700; }
.resumo-total-label { font-size:14px;color:rgba(255,255,255,.8); }
.resumo-total-val   { font-size:24px;font-weight:700;color:var(--green-l); }
.desconto-badge {
  display:inline-flex;align-items:center;gap:4px;
  background:rgba(16,185,129,.2);border:1px solid rgba(16,185,129,.3);
  border-radius:6px;padding:3px 8px;font-size:11px;font-weight:700;color:var(--green-l);
}

/* CONTRATO */
.contrato-box {
  background:white;border:1px solid var(--border);border-radius:var(--radius);
  padding:28px;max-height:360px;overflow-y:auto;margin-bottom:16px;
  font-size:13px;line-height:1.8;color:var(--ink);
}
.contrato-box h3 { font-family:var(--font-h);font-size:16px;margin-bottom:12px;text-align:center; }
.contrato-box h4 { font-size:13px;font-weight:700;margin:16px 0 6px;text-transform:uppercase;letter-spacing:.5px; }
.contrato-box p  { margin-bottom:10px; }

/* ASSINATURA */
.sig-area {
  border:2px dashed var(--border);border-radius:var(--radius);
  background:var(--bg);position:relative;overflow:hidden;
  margin-bottom:12px;
}
.sig-area canvas { display:block;cursor:crosshair;touch-action:none; }
.sig-placeholder {
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  text-align:center;pointer-events:none;
}
.sig-placeholder-icon { font-size:28px;color:var(--border);margin-bottom:6px; }
.sig-placeholder-text { font-size:12px;color:var(--muted); }
.sig-actions { display:flex;gap:8px;margin-bottom:16px; }

/* BOT√ïES */
.btn-primary {
  background:var(--green);color:white;border:none;
  padding:13px 28px;border-radius:10px;
  font-family:var(--font-b);font-size:14px;font-weight:700;
  cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:8px;
}
.btn-primary:hover { background:#086649;transform:translateY(-1px);box-shadow:0 4px 16px rgba(10,124,92,.3); }
.btn-primary.full { width:100%;justify-content:center; }
.btn-primary:disabled { opacity:.5;cursor:not-allowed;transform:none; }
.btn-outline {
  background:transparent;color:var(--ink);border:1.5px solid var(--border);
  padding:11px 20px;border-radius:10px;font-family:var(--font-b);
  font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;
}
.btn-outline:hover { border-color:var(--green-l);color:var(--green); }
.btn-sm {
  padding:7px 14px;font-size:12px;border-radius:8px;border:1.5px solid var(--border);
  background:white;cursor:pointer;font-family:var(--font-b);font-weight:600;color:var(--muted);
  transition:all .15s;
}
.btn-sm:hover { border-color:var(--danger);color:var(--danger); }
.nav-row { display:flex;justify-content:space-between;align-items:center;margin-top:24px; }

/* SUCESSO */
.sucesso-box { text-align:center;padding:48px 24px; }
.sucesso-icon { font-size:64px;margin-bottom:20px; }
.sucesso-title { font-family:var(--font-h);font-size:28px;margin-bottom:12px;color:var(--green); }
.sucesso-sub { color:var(--muted);font-size:15px;max-width:400px;margin:0 auto 32px; }
.sucesso-badges { display:flex;gap:10px;justify-content:center;flex-wrap:wrap; }
.sucesso-badge {
  background:var(--green-xl);border:1px solid rgba(16,185,129,.3);
  border-radius:8px;padding:10px 16px;font-size:13px;font-weight:600;color:var(--green);
}

/* CHECKBOX */
.check-row { display:flex;align-items:flex-start;gap:10px;margin-bottom:12px; }
.check-row input[type=checkbox] { margin-top:2px;width:16px;height:16px;cursor:pointer;accent-color:var(--green); }
.check-row label { font-size:13px;cursor:pointer;line-height:1.5; }

/* INFO BOX */
.info-box {
  background:var(--green-xl);border:1px solid rgba(16,185,129,.2);
  border-radius:10px;padding:14px;margin-bottom:16px;font-size:13px;color:var(--green);
  display:flex;gap:10px;
}

/* TOAST */
.toast {
  position:fixed;bottom:24px;right:24px;z-index:9999;
  background:var(--ink);color:white;padding:13px 20px;
  border-radius:10px;font-size:13px;font-weight:500;
  box-shadow:0 8px 32px rgba(0,0,0,.2);
  transition:all .3s;opacity:0;pointer-events:none;
}
.toast.show { opacity:1; }
.toast.success { border-left:4px solid var(--green-l); }
.toast.error   { border-left:4px solid var(--danger); }

/* UPLOAD DOCS */
.upload-box {
  border: 2px dashed var(--border);
  border-radius: 12px;
  padding: 24px 16px;
  text-align: center;
  cursor: pointer;
  transition: all .2s;
  background: white;
  min-height: 100px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.upload-box:hover { border-color: var(--green); background: #f0fdf8; }
.upload-box.has-file { border-color: var(--green-l); background: #f0fdf4; border-style: solid; }
.upload-box.has-file:hover { background: #dcfce7; }
.doc-preview {
  display: flex;
  align-items: center;
  gap: 12px;
  text-align: left;
  padding: 0 8px;
}
.doc-preview-icon { font-size: 32px; flex-shrink: 0; }
.doc-preview-info { flex: 1; overflow: hidden; }
.doc-preview-name { font-size: 13px; font-weight: 600; color: var(--ink); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.doc-preview-size { font-size: 11px; color: var(--muted); margin-top: 2px; }
.doc-preview-ok { font-size: 18px; color: var(--green); flex-shrink: 0; }
.doc-remove { background: none; border: none; color: var(--danger); font-size: 13px; cursor: pointer; margin-top: 6px; font-family: var(--font-b); padding: 0; }
</style>
</head>
<body>

<!-- HERO -->
<div class="hero">
  <h1>Reserve sua sala,<br><em>sem complica√ß√£o.</em></h1>
  <p>Verifique seu e-mail, preencha seus dados e assine o contrato digitalmente.</p>
</div>

<!-- BARRA DE PASSOS -->
<div class="steps-bar">
  <div class="step active" id="step1"><div class="step-num">1</div> Verifica√ß√£o</div>
  <div class="step-sep"></div>
  <div class="step" id="step2"><div class="step-num">2</div> Cadastro</div>
  <div class="step-sep"></div>
  <div class="step" id="step3"><div class="step-num">3</div> Contrato</div>
  <div class="step-sep"></div>
  <div class="step" id="step4"><div class="step-num">4</div> Assinatura</div>
</div>

<div class="wrap">

  <!-- ‚ïê‚ïê TELA 0: VERIFICA√á√ÉO DE E-MAIL ‚ïê‚ïê -->
  <div class="screen active" id="screenVerificacao">
    <div class="sec-title">Verifica√ß√£o de e-mail</div>
    <div class="sec-sub">Digite seu e-mail para receber o c√≥digo de acesso</div>
    <div class="card">
      <!-- Etapa A: digitar email -->
      <div id="etapaEmail">
        <div class="field">
          <label>E-mail profissional</label>
          <input type="email" id="veriEmail" placeholder="seu@email.com" />
        </div>
        <div id="testeBanner" style="display:none;background:#fef3c7;border:1px solid #fcd34d;border-radius:8px;padding:10px 14px;font-size:12px;color:#92400e;margin-bottom:12px;">
          üß™ <strong>Modo teste:</strong> o c√≥digo aparecer√° abaixo sem envio de e-mail.
        </div>
        <button class="btn-primary" onclick="enviarToken()" id="btnEnviarToken">Enviar c√≥digo ‚Üí</button>
      </div>
      <!-- Etapa B: digitar token -->
      <div id="etapaToken" style="display:none;">
        <div style="text-align:center;margin-bottom:20px;">
          <div style="font-size:13px;color:var(--muted);margin-bottom:4px;">C√≥digo enviado para</div>
          <div style="font-weight:700;color:var(--ink);" id="veriEmailMostra"></div>
        </div>
        <div id="tokenTestBox" style="display:none;background:#f0fdf4;border:1px solid #86efac;border-radius:8px;padding:12px;text-align:center;margin-bottom:16px;">
          <div style="font-size:11px;color:#166534;font-weight:600;text-transform:uppercase;letter-spacing:.5px;">C√≥digo de teste</div>
          <div id="tokenTestValor" style="font-size:32px;font-weight:800;letter-spacing:8px;color:#15803d;margin-top:4px;"></div>
        </div>
        <div class="field">
          <label>C√≥digo de 6 d√≠gitos</label>
          <input type="text" id="veriToken" placeholder="000000" maxlength="6"
            style="text-align:center;font-size:24px;font-weight:700;letter-spacing:8px;"
            oninput="this.value=this.value.replace(/\D/g,'')" />
        </div>
        <button class="btn-primary" onclick="validarToken()">Confirmar c√≥digo ‚Üí</button>
        <div style="text-align:center;margin-top:12px;">
          <button onclick="voltarParaEmail()" style="background:none;border:none;color:var(--muted);font-size:13px;cursor:pointer;font-family:var(--font-b);">‚Üê Trocar e-mail</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê TELA 1: CADASTRO ‚ïê‚ïê -->
  <div class="screen" id="screenCadastro">
    <div class="sec-title">Seus dados</div>
    <div class="sec-sub">Preencha suas informa√ß√µes para continuar</div>
    <div class="card">
      <div class="field"><label>Nome completo *</label><input type="text" id="psiNome" placeholder="Dr. Carlos Mendes" /></div>
      <div class="field-row">
        <div class="field">
          <label>Conselho Regional *</label>
          <select id="psiConselho">
            <option value="">Selecione...</option>
            <option value="CRP">CRP ‚Äî Psicologia</option>
            <option value="CRM">CRM ‚Äî Medicina</option>
            <option value="CRO">CRO ‚Äî Odontologia</option>
            <option value="CRN">CRN ‚Äî Nutri√ß√£o</option>
            <option value="CREFITO">CREFITO ‚Äî Fisioterapia</option>
            <option value="CRFa">CRFa ‚Äî Fonoaudiologia</option>
            <option value="COREN">COREN ‚Äî Enfermagem</option>
            <option value="CRF">CRF ‚Äî Farm√°cia</option>
            <option value="CRBM">CRBM ‚Äî Biomedicina</option>
            <option value="CRBio">CRBio ‚Äî Biologia</option>
            <option value="CRFA">CRFA ‚Äî Fonoaudiologia</option>
            <option value="CRESS">CRESS ‚Äî Servi√ßo Social</option>
            <option value="CRQ">CRQ ‚Äî Qu√≠mica</option>
            <option value="CFO">CFO ‚Äî Odontologia Federal</option>
            <option value="CFM">CFM ‚Äî Medicina Federal</option>
            <option value="Outro">Outro</option>
          </select>
        </div>
        <div class="field"><label>N√∫mero do registro *</label><input type="text" id="psiCRP" placeholder="Ex: 06/12345" /></div>
      </div>
      <div class="field-row">
        <div class="field"><label>WhatsApp *</label><input type="text" id="psiTel" placeholder="(11) 99999-9999" oninput="mascaraTel(this)" /></div>
        <div class="field"><label>CPF *</label><input type="text" id="psiCPF" placeholder="000.000.000-00" oninput="mascaraCPF(this)" maxlength="14" /></div>
      </div>
      <!-- Endere√ßo com CEP autom√°tico -->
      <div style="background:#f8fafc;border-radius:10px;padding:16px;margin-top:4px;">
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-bottom:12px;">Endere√ßo</div>
        <div class="field-row">
          <div class="field" style="flex:0 0 160px;">
            <label>CEP * <span id="cepStatus" style="font-size:11px;color:var(--green);font-weight:600;"></span></label>
            <input type="text" id="psiCEP" placeholder="00000-000" maxlength="9" oninput="mascaraEBuscaCEP(this)" />
          </div>
          <div class="field">
            <label>Logradouro</label>
            <input type="text" id="psiRua" placeholder="Preenchido automaticamente" readonly style="background:#f1f5f9;color:var(--muted);" />
          </div>
        </div>
        <div class="field-row">
          <div class="field" style="flex:0 0 100px;"><label>N√∫mero *</label><input type="text" id="psiNumero" placeholder="123" /></div>
          <div class="field"><label>Complemento</label><input type="text" id="psiComplemento" placeholder="Apto, Sala..." /></div>
          <div class="field"><label>Bairro</label><input type="text" id="psiBairro" readonly style="background:#f1f5f9;color:var(--muted);" /></div>
        </div>
        <div class="field-row">
          <div class="field"><label>Cidade</label><input type="text" id="psiCidade" readonly style="background:#f1f5f9;color:var(--muted);" /></div>
          <div class="field" style="flex:0 0 80px;"><label>UF</label><input type="text" id="psiUF" maxlength="2" readonly style="background:#f1f5f9;color:var(--muted);" /></div>
        </div>
      </div>
    </div>
      <!-- Documentos obrigat√≥rios -->
      <div style="background:#f8fafc;border-radius:10px;padding:16px;margin-top:16px;">
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-bottom:4px;">Documentos obrigat√≥rios</div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:16px;">Envie foto ou scan leg√≠vel. Formatos aceitos: JPG, PNG ou PDF (at√© 5MB cada)</div>

        <!-- RG ou CNH -->
        <div class="field">
          <label>RG ou CNH (documento com foto) *</label>
          <div class="upload-box" id="uploadRGBox" onclick="document.getElementById('inputRG').click()">
            <input type="file" id="inputRG" accept="image/*,.pdf" style="display:none" onchange="previewDoc('RG',this)" />
            <div id="uploadRGPlaceholder">
              <div style="font-size:28px;margin-bottom:8px;">üìÑ</div>
              <div style="font-weight:600;color:var(--ink);font-size:14px;">Clique para enviar RG ou CNH</div>
              <div style="font-size:12px;color:var(--muted);margin-top:4px;">Frente e verso ‚Äî JPG, PNG ou PDF</div>
            </div>
            <div id="uploadRGPreview" style="display:none;"></div>
          </div>
        </div>

        <!-- Carteirinha do conselho -->
        <div class="field" style="margin-top:12px;">
          <label>Carteirinha do conselho profissional *</label>
          <div class="upload-box" id="uploadConselhoBox" onclick="document.getElementById('inputConselho').click()">
            <input type="file" id="inputConselho" accept="image/*,.pdf" style="display:none" onchange="previewDoc('Conselho',this)" />
            <div id="uploadConselhoPlaceholder">
              <div style="font-size:28px;margin-bottom:8px;">ü™™</div>
              <div style="font-weight:600;color:var(--ink);font-size:14px;">Clique para enviar carteirinha</div>
              <div style="font-size:12px;color:var(--muted);margin-top:4px;">CRP, CRM, CRO ou outro conselho ‚Äî JPG, PNG ou PDF</div>
            </div>
            <div id="uploadConselhoPreview" style="display:none;"></div>
          </div>
        </div>
      </div>

    <div class="nav-row" style="margin-top:24px;">
      <button class="btn-outline" onclick="irPara('screenVerificacao',1)">‚Üê Voltar</button>
      <button class="btn-primary" onclick="irParaContrato()">Pr√≥ximo ‚Üí Ver contrato</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê TELA 2: RESERVA (removida ‚Äî feita no painel) ‚ïê‚ïê -->
  <div class="screen" id="screenReserva">
    <div class="sec-title">Tipo de subloca√ß√£o</div>
    <div class="sec-sub">Escolha como quer usar a sala</div>

    <div class="tipo-grid">
      <div class="tipo-card" id="cardAvulso" onclick="selecionarTipo('avulso')">
        <div class="tipo-icon">üìÖ</div>
        <div class="tipo-name">Avulso</div>
        <div class="tipo-desc">Reserve hor√°rios espec√≠ficos quando precisar. Paga somente o que usar.</div>
        <div class="tipo-price" id="precoAvulso">R$ 31,90/sess√£o</div>
      </div>
      <div class="tipo-card" id="cardBloco" onclick="selecionarTipo('bloco')">
        <div class="tipo-icon">üìÜ</div>
        <div class="tipo-name">Bloco Fixo</div>
        <div class="tipo-desc">Reserve um dia e hor√°rio fixo toda semana. Desconto progressivo por quantidade.</div>
        <div class="tipo-price" id="precoBloco">A partir de R$ 80/bloco</div>
      </div>
    </div>

    <!-- AVULSO: escolhe hor√°rio -->
    <div id="secAvulso" style="display:none">
      <div class="card">
        <div class="card-title">Escolha o dia e hor√°rio</div>
        <div class="card-sub">Selecione nos hor√°rios dispon√≠veis abaixo</div>
        <div class="field"><label>Dia</label>
          <select id="avulso_dia">
            <option value="">Selecione o dia...</option>
            <option value="segunda">Segunda-feira</option>
            <option value="terca">Ter√ßa-feira</option>
            <option value="quarta">Quarta-feira</option>
            <option value="quinta">Quinta-feira</option>
            <option value="sexta">Sexta-feira</option>
          </select>
        </div>
        <div class="field"><label>Sala</label>
          <select id="avulso_sala">
            <option value="">Selecione a sala...</option>
            <option value="s1">Sala 01 ‚Äî 2¬∫ andar</option>
            <option value="s2">Sala 02 ‚Äî 2¬∫ andar</option>
            <option value="s3">Sala 03 ‚Äî 3¬∫ andar (ampla)</option>
          </select>
        </div>
        <div class="field"><label>Hor√°rio dispon√≠vel</label>
          <div class="horas-grid" id="horasAvulso"></div>
        </div>
      </div>
    </div>

    <!-- BLOCO: escolhe dia + hora fixos -->
    <div id="secBloco" style="display:none">
      <div class="card">
        <div class="card-title">Configure seu bloco fixo</div>
        <div class="card-sub">O hor√°rio escolhido ficar√° reservado para voc√™ todas as semanas do m√™s</div>

        <div class="field"><label>Quantos blocos? (dias fixos/semana)</label>
          <select id="bloco_qtd" onchange="calcularBloco()">
            <option value="1">1 bloco ‚Äî 1 dia fixo por semana</option>
            <option value="2">2 blocos ‚Äî 2 dias fixos por semana (‚àí30%)</option>
            <option value="3">3 blocos ‚Äî 3 dias fixos por semana (‚àí45%)</option>
          </select>
        </div>

        <div id="blocoSlotsWrap"></div>

        <div class="field"><label>Sala</label>
          <select id="bloco_sala">
            <option value="">Selecione a sala...</option>
            <option value="s1">Sala 01 ‚Äî R$ 80/bloco</option>
            <option value="s2">Sala 02 ‚Äî R$ 80/bloco</option>
            <option value="s3">Sala 03 ampla ‚Äî R$ 100/bloco</option>
          </select>
        </div>
      </div>

      <div class="resumo-box" id="resumoBloco" style="display:none">
        <div style="font-size:12px;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.8px;margin-bottom:14px">Resumo do bloco</div>
        <div id="resumoBlocoContent"></div>
      </div>
    </div>

    <div class="nav-row">
      <button class="btn-outline" onclick="irPara('screenCadastro',2)">‚Üê Voltar</button>
      <button class="btn-primary" onclick="irParaContrato()">Pr√≥ximo ‚Üí Ver contrato</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê TELA 3: CONTRATO ‚ïê‚ïê -->
  <div class="screen" id="screenContrato">
    <div class="sec-title">Contrato de Subloca√ß√£o</div>
    <div class="sec-sub">Leia com aten√ß√£o antes de assinar</div>

    <div class="info-box">
      ‚ú¶ Este contrato tem validade de <strong>12 meses</strong>. Ap√≥s esse per√≠odo, um novo contrato ser√° gerado automaticamente.
    </div>

    <div class="contrato-box" id="contratoTexto"></div>

    <div class="check-row">
      <input type="checkbox" id="checkContrato" />
      <label for="checkContrato">Li e aceito os termos do contrato de subloca√ß√£o acima</label>
    </div>
    <div class="check-row">
      <input type="checkbox" id="checkLGPD" />
      <label for="checkLGPD">Autorizo o tratamento dos meus dados conforme a LGPD</label>
    </div>

    <div class="nav-row">
      <button class="btn-outline" onclick="irPara('screenReserva',3)">‚Üê Voltar</button>
      <button class="btn-primary" onclick="irParaAssinatura()">Pr√≥ximo ‚Üí Assinar</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê TELA 4: ASSINATURA ‚ïê‚ïê -->
  <div class="screen" id="screenAssinatura">
    <div class="sec-title">Assinatura Digital</div>
    <div class="sec-sub">Assine com o dedo ou mouse para confirmar o contrato</div>

    <div class="card">
      <div class="card-title">Sua assinatura</div>
      <div class="card-sub">Use o mouse ou o dedo na tela para assinar abaixo</div>
      <div class="sig-area">
        <canvas id="sigCanvas" width="640" height="160"></canvas>
        <div class="sig-placeholder" id="sigPlaceholder">
          <div class="sig-placeholder-icon">‚úç</div>
          <div class="sig-placeholder-text">Assine aqui</div>
        </div>
      </div>
      <div class="sig-actions">
        <button class="btn-sm" onclick="limparAssinatura()">‚úï Limpar</button>
        <span style="font-size:12px;color:var(--muted);align-self:center">Carimbado com seu IP e data/hora</span>
      </div>
    </div>

    <div class="card" id="cardAssinaturaClinica">
      <div class="card-title">Assinatura da Cl√≠nica</div>
      <div class="card-sub">Assinatura da propriet√°ria (pr√©-registrada)</div>
      <div style="border:1px solid var(--border);border-radius:8px;padding:16px;background:var(--bg);">
        <canvas id="sigClinicaCanvas" width="640" height="100" style="display:block"></canvas>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-top:8px">
        Dra. Ana Lima ‚Äî CRM 12345 ‚Äî Propriet√°ria da Cl√≠nica Esperan√ßa
      </div>
    </div>

    <div class="nav-row">
      <button class="btn-outline" onclick="irPara('screenContrato',3)">‚Üê Voltar</button>
      <button class="btn-primary full" onclick="finalizarContrato()" id="btnFinalizar" style="margin-top:12px">‚úì Finalizar e gerar contrato</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê TELA 5: SUCESSO ‚ïê‚ïê -->
  <div class="screen" id="screenSucesso">
    <div class="sucesso-box">
      <div class="sucesso-icon">üéâ</div>
      <div class="sucesso-title">Contrato assinado!</div>
      <div class="sucesso-sub">Sua reserva foi confirmada. Voc√™ receber√° o contrato por e-mail em instantes.</div>
      <div class="sucesso-badges">
        <div class="sucesso-badge">üìÑ Contrato v√°lido por 12 meses</div>
        <div class="sucesso-badge" id="sucessoBadgeTipo">üìÖ Avulso</div>
        <div class="sucesso-badge" id="sucessoBadgeValor">R$ ‚Äî</div>
      </div>
      <div style="margin-top:32px">
        <button class="btn-primary" onclick="irParaPainelPsi()">Acessar meu painel ‚Üí</button>
      </div>
    </div>
  </div>

</div><!-- /wrap -->

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê CONFIGURA√á√ïES DA CL√çNICA (viriam do banco) ‚ïê‚ïê‚ïê
const CONFIG_CLINICA = {
  nome: 'Cl√≠nica Esperan√ßa',
  proprietaria: 'Dra. Ana Lima',
  cpf_cnpj: '12.345.678/0001-90',
  endereco: 'Rua das Flores, 123 ‚Äî S√£o Paulo/SP',
  precos: {
    avulso: 31.90,
    bloco1: 80.00,
    bloco2: 80.00 * 2 * (1 - 0.30), // 2 blocos -30%
    bloco3: 80.00 * 3 * (1 - 0.45), // 3 blocos -45%
    desconto2: 30,
    desconto3: 45,
  },
  cancelamento: {
    avulso_horas: 24,      // horas antes para cancelar avulso
    bloco_dias_parcial: 7, // dias de aviso para cancelar dia do bloco
    bloco_dias_total: 30,  // dias para cancelar bloco total
  },
  assinatura_clinica: null // canvas salvo em base64
};

// ‚ïê‚ïê‚ïê ESTADO ‚ïê‚ïê‚ïê
let dadosPsi = {};
let tipoSelecionado = '';
let reservaData = {};
let sigDrawing = false;
let sigCtx = null;
let sigHasDraw = false;

// ‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê
function toast(msg, type='success') {
  const el = document.getElementById('toast');
  el.textContent = msg; el.className = 'toast show ' + type;
  setTimeout(() => el.classList.remove('show'), 3500);
}

function atualizarSteps(ativo) {
  for (let i = 1; i <= 4; i++) {
    const el = document.getElementById('step' + i);
    if (el) el.className = 'step' + (i === ativo ? ' active' : i < ativo ? ' done' : '');
  }
}

function irPara(screenId, stepNum) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(screenId).classList.add('active');
  atualizarSteps(stepNum);
  window.scrollTo({top:0,behavior:'smooth'});
}

// ‚ïê‚ïê‚ïê TELA 2 ‚Üí 3 ‚ïê‚ïê‚ïê
function irParaReserva() {
  const nome     = document.getElementById('psiNome').value.trim();
  const conselho = document.getElementById('psiConselho').value;
  const crp      = document.getElementById('psiCRP').value.trim();
  const cpf      = document.getElementById('psiCPF').value.trim();
  const tel      = document.getElementById('psiTel').value.trim();
  const cep      = document.getElementById('psiCEP').value.trim();
  const numero   = document.getElementById('psiNumero').value.trim();

  if (!nome)     { toast('Informe o nome completo', 'error'); return; }
  if (!conselho) { toast('Selecione o conselho regional', 'error'); return; }
  if (!crp)      { toast('Informe o n√∫mero do registro', 'error'); return; }
  if (!cpf)      { toast('Informe o CPF', 'error'); return; }
  if (!tel)      { toast('Informe o WhatsApp', 'error'); return; }
  if (!cep)      { toast('Informe o CEP', 'error'); return; }
  if (!numero)   { toast('Informe o n√∫mero do endere√ßo', 'error'); return; }

  const rua  = document.getElementById('psiRua').value;
  const comp = document.getElementById('psiComplemento').value;
  const bairro = document.getElementById('psiBairro').value;
  const cidade = document.getElementById('psiCidade').value;
  const uf   = document.getElementById('psiUF').value;

  dadosPsi = {
    nome, conselho, crp, cpf, tel,
    email: emailVerificado,
    end: `${rua}, ${numero}${comp ? ' ' + comp : ''} ‚Äî ${bairro}, ${cidade}/${uf} ‚Äî CEP ${cep}`
  };

  renderBlocoSlots();
  renderHorasAvulso();
  irPara('screenContrato', 3);
}

// ‚ïê‚ïê‚ïê TIPO ‚ïê‚ïê‚ïê
function selecionarTipo(tipo) {
  tipoSelecionado = tipo;
  document.getElementById('cardAvulso').classList.toggle('selected', tipo==='avulso');
  document.getElementById('cardBloco').classList.toggle('selected', tipo==='bloco');
  document.getElementById('secAvulso').style.display = tipo==='avulso' ? 'block' : 'none';
  document.getElementById('secBloco').style.display  = tipo==='bloco'  ? 'block' : 'none';
}

// ‚ïê‚ïê‚ïê HORAS AVULSO ‚ïê‚ïê‚ïê
const HORAS_DISP = ['08:00','09:00','10:00','11:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00'];
const OCUPADOS   = ['09:00','14:00']; // simula√ß√£o

function renderHorasAvulso() {
  document.getElementById('horasAvulso').innerHTML = HORAS_DISP.map(h => {
    const ocup = OCUPADOS.includes(h);
    return `<button class="hora-btn ${ocup?'ocupado':''}" onclick="${ocup?'':''}" data-hora="${h}" ${ocup?'disabled':''}>${h}</button>`;
  }).join('');
  document.getElementById('horasAvulso').querySelectorAll('.hora-btn:not(.ocupado)').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.hora-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      reservaData.horaAvulso = btn.dataset.hora;
    });
  });
}

// ‚ïê‚ïê‚ïê BLOCOS ‚ïê‚ïê‚ïê
function renderBlocoSlots() {
  const qtd = parseInt(document.getElementById('bloco_qtd')?.value || 1);
  let html = '';
  for (let i = 1; i <= qtd; i++) {
    html += `
      <div class="card" style="margin-bottom:12px">
        <div class="card-title">Bloco ${i}</div>
        <div class="field-row">
          <div class="field"><label>Dia fixo</label>
            <select id="bloco_dia_${i}" onchange="calcularBloco()">
              <option value="">Escolha o dia...</option>
              <option value="segunda">Segunda-feira</option>
              <option value="terca">Ter√ßa-feira</option>
              <option value="quarta">Quarta-feira</option>
              <option value="quinta">Quinta-feira</option>
              <option value="sexta">Sexta-feira</option>
            </select>
          </div>
          <div class="field"><label>Hor√°rio fixo</label>
            <select id="bloco_hora_${i}" onchange="calcularBloco()">
              <option value="">Escolha o hor√°rio...</option>
              ${HORAS_DISP.map(h=>`<option value="${h}">${h}</option>`).join('')}
            </select>
          </div>
        </div>
      </div>
    `;
  }
  document.getElementById('blocoSlotsWrap').innerHTML = html;
}

function calcularBloco() {
  const qtd = parseInt(document.getElementById('bloco_qtd').value);
  renderBlocoSlots();

  const precos = CONFIG_CLINICA.precos;
  const sala   = document.getElementById('bloco_sala')?.value;
  const valorBase = sala === 's3' ? 100 : 80;
  const desconto  = qtd === 2 ? precos.desconto2 : qtd === 3 ? precos.desconto3 : 0;
  const total     = valorBase * qtd * (1 - desconto/100) * 4; // 4 semanas

  document.getElementById('resumoBloco').style.display = 'block';
  document.getElementById('resumoBlocoContent').innerHTML = `
    <div class="resumo-row">
      <span class="resumo-label">Blocos selecionados</span>
      <span class="resumo-val">${qtd} dia${qtd>1?'s':''} fixo${qtd>1?'s':''}/semana</span>
    </div>
    <div class="resumo-row">
      <span class="resumo-label">Valor por bloco/semana</span>
      <span class="resumo-val">R$ ${valorBase.toFixed(2)}</span>
    </div>
    ${desconto > 0 ? `
    <div class="resumo-row">
      <span class="resumo-label">Desconto aplicado</span>
      <span class="resumo-val" style="color:var(--green-l)">
        <span class="desconto-badge">‚àí${desconto}%</span>
      </span>
    </div>` : ''}
    <div class="resumo-row">
      <span class="resumo-total-label">Total mensal estimado</span>
      <span class="resumo-total-val">R$ ${total.toLocaleString('pt-BR',{minimumFractionDigits:2})}</span>
    </div>
    <div style="font-size:11px;color:rgba(255,255,255,.4);margin-top:10px">
      * Cobran√ßa mensal fixa. O valor √© devido mesmo em caso de aus√™ncia.
    </div>
  `;

  reservaData.blocoQtd     = qtd;
  reservaData.blocoValor   = total;
  reservaData.blocoDesconto= desconto;
}

// ‚îÄ‚îÄ‚îÄ UPLOAD DE DOCS ‚îÄ‚îÄ‚îÄ
let docRG = null;
let docConselho = null;

function previewDoc(tipo, input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 5 * 1024 * 1024) { toast('Arquivo muito grande. M√°ximo 5MB.', 'error'); input.value=''; return; }

  const isPdf = file.type === 'application/pdf';
  const sizeStr = file.size > 1024*1024
    ? (file.size/1024/1024).toFixed(1) + ' MB'
    : (file.size/1024).toFixed(0) + ' KB';
  const icon = isPdf ? 'üìã' : 'üñºÔ∏è';

  const boxId  = 'upload' + tipo + 'Box';
  const prevId = 'upload' + tipo + 'Preview';
  const phId   = 'upload' + tipo + 'Placeholder';

  document.getElementById(boxId).classList.add('has-file');
  document.getElementById(phId).style.display  = 'none';
  document.getElementById(prevId).style.display = 'block';
  document.getElementById(prevId).innerHTML = `
    <div class="doc-preview">
      <div class="doc-preview-icon">${icon}</div>
      <div class="doc-preview-info">
        <div class="doc-preview-name">${file.name}</div>
        <div class="doc-preview-size">${sizeStr}</div>
        <button class="doc-remove" onclick="event.stopPropagation();removerDoc('${tipo}')">‚úï Remover</button>
      </div>
      <div class="doc-preview-ok">‚úì</div>
    </div>`;

  if (isPdf) {
    tipo === 'RG' ? (docRG = file) : (docConselho = file);
  } else {
    const reader = new FileReader();
    reader.onload = e => { tipo === 'RG' ? (docRG = e.target.result) : (docConselho = e.target.result); };
    reader.readAsDataURL(file);
  }
}

function removerDoc(tipo) {
  const boxId  = 'upload' + tipo + 'Box';
  const prevId = 'upload' + tipo + 'Preview';
  const phId   = 'upload' + tipo + 'Placeholder';
  const inputId = 'input' + tipo;
  document.getElementById(boxId).classList.remove('has-file');
  document.getElementById(phId).style.display  = 'block';
  document.getElementById(prevId).style.display = 'none';
  document.getElementById(prevId).innerHTML = '';
  document.getElementById(inputId).value = '';
  tipo === 'RG' ? (docRG = null) : (docConselho = null);
}

// ‚ïê‚ïê‚ïê TELA 2 ‚Üí 3 ‚ïê‚ïê‚ïê
function irParaContrato() {
  // Validar dados pessoais
  const nome     = document.getElementById('psiNome').value.trim();
  const conselho = document.getElementById('psiConselho').value;
  const crp      = document.getElementById('psiCRP').value.trim();
  const cpf      = document.getElementById('psiCPF').value.trim();
  const tel      = document.getElementById('psiTel').value.trim();
  const cep      = document.getElementById('psiCEP').value.trim();
  const numero   = document.getElementById('psiNumero').value.trim();

  if (!nome)     { toast('Informe o nome completo', 'error'); return; }
  if (!conselho) { toast('Selecione o conselho regional', 'error'); return; }
  if (!crp)      { toast('Informe o n√∫mero do registro', 'error'); return; }
  if (!cpf)      { toast('Informe o CPF', 'error'); return; }
  if (!tel)      { toast('Informe o WhatsApp', 'error'); return; }
  if (!cep || !numero) { toast('Preencha o endere√ßo completo com CEP', 'error'); return; }

  // Validar documentos
  if (!docRG)       { toast('Envie o documento com foto (RG ou CNH)', 'error'); return; }
  if (!docConselho) { toast('Envie a carteirinha do conselho profissional', 'error'); return; }

  const rua  = document.getElementById('psiRua').value;
  const comp = document.getElementById('psiComplemento').value;
  const bairro = document.getElementById('psiBairro').value;
  const cidade = document.getElementById('psiCidade').value;
  const uf   = document.getElementById('psiUF').value;

  dadosPsi = {
    nome, conselho, crp, cpf, tel,
    email: emailVerificado,
    end: `${rua}, ${numero}${comp ? ', ' + comp : ''} ‚Äî ${bairro}, ${cidade}/${uf} ‚Äî CEP ${cep}`
  };

  gerarContratoTexto();
  irPara('screenContrato', 3);
}

function gerarContratoTexto() {
  const hoje = new Date().toLocaleDateString('pt-BR');
  const venc  = new Date(); venc.setFullYear(venc.getFullYear()+1);
  const vencStr = venc.toLocaleDateString('pt-BR');
  const cfg = CONFIG_CLINICA;

  let clausulasEspecificas = '';

  if (tipoSelecionado === 'avulso') {
    const dia  = document.getElementById('avulso_dia')?.value  || '‚Äî';
    const hora = reservaData.horaAvulso || '‚Äî';
    clausulasEspecificas = `
      <h4>CL√ÅUSULA 3¬™ ‚Äî DO TIPO DE SUBLOCA√á√ÉO (AVULSO)</h4>
      <p>A SUBLOCAT√ÅRIA utilizar√° a sala de forma avulsa, sendo cobrado o valor de <strong>R$ ${cfg.precos.avulso.toFixed(2)}</strong> por sess√£o utilizada, conforme agenda previamente reservada.</p>
      <p>Dia selecionado: <strong>${dia}</strong> ‚Äî Hor√°rio: <strong>${hora}</strong>.</p>
      <h4>CL√ÅUSULA 4¬™ ‚Äî DO CANCELAMENTO</h4>
      <p>O cancelamento de sess√£o avulsa deve ser comunicado com no m√≠nimo <strong>${cfg.cancelamento.avulso_horas} horas</strong> de anteced√™ncia. Cancelamentos fora deste prazo acarretar√£o na cobran√ßa integral da sess√£o.</p>
    `;
  } else {
    const qtd    = reservaData.blocoQtd || 1;
    const total  = (reservaData.blocoValor || 0).toLocaleString('pt-BR', {minimumFractionDigits:2});
    const desc   = reservaData.blocoDesconto || 0;
    clausulasEspecificas = `
      <h4>CL√ÅUSULA 3¬™ ‚Äî DO TIPO DE SUBLOCA√á√ÉO (BLOCO FIXO)</h4>
      <p>A SUBLOCAT√ÅRIA reservar√° <strong>${qtd} dia(s) fixo(s) por semana</strong> com desconto de <strong>${desc}%</strong>, totalizando o valor mensal de <strong>R$ ${total}</strong>, cobrado independentemente de uso.</p>
      <p>O valor do bloco √© devido integralmente mesmo que a SUBLOCAT√ÅRIA n√£o utilize os hor√°rios reservados, sendo este contrato de car√°ter irrevog√°vel quanto √† cobran√ßa mensal.</p>
      <h4>CL√ÅUSULA 4¬™ ‚Äî DO CANCELAMENTO DO BLOCO</h4>
      <p><strong>Cancelamento parcial:</strong> Para cancelar um dia espec√≠fico do bloco, a SUBLOCAT√ÅRIA deve comunicar com no m√≠nimo <strong>${cfg.cancelamento.bloco_dias_parcial} dias</strong> de anteced√™ncia.</p>
      <p><strong>Cancelamento total:</strong> Para rescis√£o total do contrato de bloco, √© necess√°rio comunica√ß√£o formal com <strong>${cfg.cancelamento.bloco_dias_total} dias</strong> de anteced√™ncia. Cancelamentos sem aviso pr√©vio incorrem em multa correspondente a <strong>1 (uma) mensalidade</strong>.</p>
    `;
  }

  const html = `
    <h3>CONTRATO DE SUBLOCA√á√ÉO DE SALA</h3>
    <p>Este instrumento particular de subloca√ß√£o de espa√ßo cl√≠nico √© celebrado entre:</p>
    <p><strong>SUBLOCADORA:</strong> SublocaF√°cil Gest√£o de Espa√ßos, inscrita no CNPJ sob n¬∫ ${cfg.cpf_cnpj || '‚Äî'}, com sede em ${cfg.endereco || '‚Äî'}.</p>
    <p><strong>SUBLOCAT√ÅRIA:</strong> ${dadosPsi.nome}, inscrita no CPF sob n¬∫ ${dadosPsi.cpf}, portador(a) do ${dadosPsi.conselho||'CRP'} ${dadosPsi.crp}, residente em ${dadosPsi.end || '‚Äî'}.</p>

    <h4>CL√ÅUSULA 1¬™ ‚Äî DO OBJETO</h4>
    <p>O presente contrato tem por objeto a subloca√ß√£o de sala de atendimento psicol√≥gico, devidamente equipada, para uso exclusivo da SUBLOCAT√ÅRIA durante os hor√°rios pactuados.</p>

    <h4>CL√ÅUSULA 2¬™ ‚Äî DA VIG√äNCIA</h4>
    <p>O presente contrato vigorar√° pelo prazo de <strong>12 (doze) meses</strong>, com in√≠cio em <strong>${hoje}</strong> e t√©rmino em <strong>${vencStr}</strong>, podendo ser renovado mediante novo instrumento.</p>

    ${clausulasEspecificas}

    <h4>CL√ÅUSULA 5¬™ ‚Äî DAS OBRIGA√á√ïES DA SUBLOCAT√ÅRIA</h4>
    <p>A SUBLOCAT√ÅRIA obriga-se a: (a) utilizar a sala exclusivamente para atendimentos de sa√∫de mental; (b) zelar pela conserva√ß√£o do espa√ßo e equipamentos; (c) cumprir as normas internas da SUBLOCADORA; (d) n√£o sublocar o espa√ßo a terceiros.</p>

    <h4>CL√ÅUSULA 6¬™ ‚Äî DO FORO</h4>
    <p>As partes elegem o foro da comarca de S√£o Paulo/SP para dirimir quaisquer controv√©rsias oriundas deste contrato.</p>

    <p style="margin-top:20px;text-align:center;font-size:12px;color:var(--muted)">
      Contrato gerado eletronicamente em ${hoje} ‚Äî IP registrado no momento da assinatura
    </p>
  `;

  document.getElementById('contratoTexto').innerHTML = html;
}

// ‚ïê‚ïê‚ïê TELA 3 ‚Üí 4 ‚ïê‚ïê‚ïê
function irParaAssinatura() {
  if (!document.getElementById('checkContrato').checked) { toast('Voc√™ precisa aceitar o contrato', 'error'); return; }
  if (!document.getElementById('checkLGPD').checked)     { toast('Voc√™ precisa aceitar os termos da LGPD', 'error'); return; }
  iniciarCanvas();
  renderAssinaturaClinica();
  irPara('screenAssinatura', 4);
}

// ‚ïê‚ïê‚ïê CANVAS ‚ïê‚ïê‚ïê
function iniciarCanvas() {
  const canvas = document.getElementById('sigCanvas');
  const ctx    = canvas.getContext('2d');
  sigCtx = ctx;
  ctx.strokeStyle = '#1a2332';
  ctx.lineWidth   = 2.5;
  ctx.lineCap     = 'round';
  ctx.lineJoin    = 'round';
  sigHasDraw      = false;

  const getPos = (e) => {
    const r = canvas.getBoundingClientRect();
    const src = e.touches ? e.touches[0] : e;
    return { x: (src.clientX - r.left) * canvas.width/r.width, y: (src.clientY - r.top) * canvas.height/r.height };
  };

  canvas.addEventListener('mousedown', e => { sigDrawing=true; const p=getPos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); document.getElementById('sigPlaceholder').style.display='none'; });
  canvas.addEventListener('mousemove', e => { if(!sigDrawing)return; const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); sigHasDraw=true; });
  canvas.addEventListener('mouseup',   () => sigDrawing=false);
  canvas.addEventListener('mouseleave',() => sigDrawing=false);
  canvas.addEventListener('touchstart', e => { e.preventDefault(); sigDrawing=true; const p=getPos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); document.getElementById('sigPlaceholder').style.display='none'; });
  canvas.addEventListener('touchmove',  e => { e.preventDefault(); if(!sigDrawing)return; const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); sigHasDraw=true; });
  canvas.addEventListener('touchend',   () => sigDrawing=false);
}

function limparAssinatura() {
  const canvas = document.getElementById('sigCanvas');
  sigCtx.clearRect(0, 0, canvas.width, canvas.height);
  sigHasDraw = false;
  document.getElementById('sigPlaceholder').style.display = 'block';
}

function renderAssinaturaClinica() {
  // Simula assinatura pr√©-registrada da propriet√°ria
  const canvas = document.getElementById('sigClinicaCanvas');
  const ctx = canvas.getContext('2d');
  ctx.strokeStyle = '#0a7c5c';
  ctx.lineWidth = 2;
  ctx.lineCap = 'round';
  // Desenha assinatura cursiva simulada
  ctx.beginPath();
  ctx.moveTo(40, 70); ctx.bezierCurveTo(60, 40, 100, 40, 120, 60);
  ctx.bezierCurveTo(140, 80, 150, 90, 180, 75);
  ctx.bezierCurveTo(210, 60, 230, 50, 260, 65);
  ctx.bezierCurveTo(290, 80, 300, 90, 330, 70);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(330, 70); ctx.bezierCurveTo(360, 50, 390, 55, 410, 70);
  ctx.bezierCurveTo(430, 85, 440, 90, 460, 75);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(100, 85); ctx.lineTo(380, 85);
  ctx.strokeStyle = 'rgba(10,124,92,.3)';
  ctx.lineWidth = 1;
  ctx.stroke();
}

// ‚ïê‚ïê‚ïê FINALIZAR ‚ïê‚ïê‚ïê
async function finalizarContrato() {
  if (!sigHasDraw) { toast('Assine o contrato antes de finalizar', 'error'); return; }

  const btn = document.getElementById('btnFinalizar');
  btn.disabled = true; btn.textContent = '‚è≥ Gerando contrato...';

  try {
    const db = getSupabase();

    // 1. Pegar cl√≠nica ID da URL (ex: ?c=uuid-da-clinica)
    const params = new URLSearchParams(window.location.search);
    const clinicaId = params.get('c') || CONFIG_CLINICA.id;

    // 2. Cadastrar psic√≥loga no banco (com docs em base64)
    const psiComDocs = {
      ...dadosPsi,
      doc_rg: typeof docRG === 'string' ? docRG : null,
      doc_conselho: typeof docConselho === 'string' ? docConselho : null,
    };
    const psiData = await dbCadastrarPsiPortal(psiComDocs, clinicaId);
    if (!psiData) throw new Error('Erro ao cadastrar psic√≥loga');

    // 3. Salvar assinatura da psic√≥loga (canvas ‚Üí base64)
    const canvas = document.getElementById('sigCanvas');
    const assinaturaPsi = canvas.toDataURL('image/png');

    // 4. Buscar assinatura da cl√≠nica
    const { data: cfg } = await db.from('config_clinica')
      .select('assinatura_proprietaria')
      .eq('clinica_id', clinicaId)
      .single();

    // 5. Calcular data de validade (1 ano)
    const hoje = new Date();
    const validade = new Date(hoje);
    validade.setFullYear(validade.getFullYear() + 1);

    // 6. Salvar contrato no banco
    const contrato = await dbSalvarContrato({
      psicolagaId: psiData.id,
      clinicaId: clinicaId,
      tipo: tipoSelecionado,
      valor: tipoSelecionado === 'bloco' ? reservaData.blocoValor : CONFIG_CLINICA.precos.avulso,
      blocoQtd: reservaData.blocoQtd || 1,
      blocoDesconto: reservaData.blocoDesconto || 0,
      dataInicio: hoje.toISOString().split('T')[0],
      dataValidade: validade.toISOString().split('T')[0],
      assinaturaPsi: assinaturaPsi,
      assinaturaClinica: cfg?.assinatura_proprietaria || '',
      texto: document.getElementById('contratoTexto').innerHTML,
      ip: ''
    });

    if (!contrato) throw new Error('Erro ao salvar contrato');

    // 7. Criar cobran√ßa inicial
    if (tipoSelecionado === 'bloco') {
      await dbSalvarCobranca({
        psiId: psiData.id,
        contratoId: contrato.id,
        descricao: `Bloco fixo ‚Äî ${reservaData.blocoQtd} dia(s)/semana`,
        valor: reservaData.blocoValor,
        vencimento: new Date(hoje.getFullYear(), hoje.getMonth() + 1, 5).toISOString().split('T')[0]
      });
    }

    // 8. Salvar psic√≥loga no localStorage para o painel dela
    localStorage.setItem('hope_psi_logada', JSON.stringify({
      id: psiData.id,
      nome: dadosPsi.nome,
      conselho: dadosPsi.conselho,
      crp: dadosPsi.crp,
      email: emailVerificado,
      clinica_id: clinicaId
    }));

    // 9. Atualizar tela de sucesso
    document.getElementById('sucessoBadgeTipo').textContent = tipoSelecionado === 'bloco' ? 'üìÜ Bloco Fixo' : 'üìÖ Avulso';
    document.getElementById('sucessoBadgeValor').textContent = tipoSelecionado === 'bloco'
      ? `R$ ${(reservaData.blocoValor||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}/m√™s`
      : `R$ ${CONFIG_CLINICA.precos.avulso.toFixed(2)}/sess√£o`;

    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screenSucesso').classList.add('active');
    window.scrollTo({top:0,behavior:'smooth'});

  } catch(err) {
    console.error(err);
    toast('Erro ao salvar contrato. Tente novamente.', 'error');
    btn.disabled = false;
    btn.textContent = '‚úì Finalizar e gerar contrato';
  }
}

function irParaPainelPsi() { window.location.href = 'painel-psi.html'; }

// ‚ïê‚ïê‚ïê VERIFICA√á√ÉO DE E-MAIL ‚ïê‚ïê‚ïê
let emailVerificado = '';
let tokenGerado = '';
const EMAIL_TESTE = 'teste@teste.com';

function enviarToken() {
  const email = document.getElementById('veriEmail').value.trim().toLowerCase();
  if (!email || !email.includes('@')) { toast('Digite um e-mail v√°lido', 'error'); return; }

  // Gerar token de 6 d√≠gitos
  tokenGerado = String(Math.floor(100000 + Math.random() * 900000));

  const isTeste = email === EMAIL_TESTE || email.endsWith('@teste.com');

  document.getElementById('etapaEmail').style.display = 'none';
  document.getElementById('etapaToken').style.display = 'block';
  document.getElementById('veriEmailMostra').textContent = email;

  if (isTeste) {
    // Modo teste: mostrar token na tela
    document.getElementById('testeBanner').style.display = 'block';
    document.getElementById('tokenTestBox').style.display = 'block';
    document.getElementById('tokenTestValor').textContent = tokenGerado;
    toast('Modo teste ativo ‚Äî c√≥digo exibido na tela', 'success');
  } else {
    // Enviar via API
    fetch('/api/send-token', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ email, token: tokenGerado })
    }).then(r => {
      if (r.ok) toast('C√≥digo enviado para ' + email, 'success');
      else toast('Erro ao enviar e-mail. Tente novamente.', 'error');
    }).catch(() => toast('Erro de conex√£o', 'error'));
  }
}

function validarToken() {
  const digitado = document.getElementById('veriToken').value.trim();
  if (!digitado) { toast('Digite o c√≥digo recebido', 'error'); return; }
  if (digitado !== tokenGerado) { toast('C√≥digo incorreto. Verifique e tente novamente.', 'error'); return; }

  emailVerificado = document.getElementById('veriEmail').value.trim();
  toast('E-mail verificado com sucesso! ‚úì', 'success');
  irPara('screenCadastro', 2);
}

function voltarParaEmail() {
  document.getElementById('etapaEmail').style.display = 'block';
  document.getElementById('etapaToken').style.display = 'none';
  document.getElementById('tokenTestBox').style.display = 'none';
  document.getElementById('testeBanner').style.display = 'none';
  document.getElementById('veriToken').value = '';
  tokenGerado = '';
}

// ‚ïê‚ïê‚ïê M√ÅSCARAS ‚ïê‚ïê‚ïê
function mascaraCPF(el) {
  let v = el.value.replace(/\D/g,'');
  v = v.replace(/(\d{3})(\d)/,'$1.$2');
  v = v.replace(/(\d{3})(\d)/,'$1.$2');
  v = v.replace(/(\d{3})(\d{1,2})$/,'$1-$2');
  el.value = v;
}
function mascaraTel(el) {
  let v = el.value.replace(/\D/g,'');
  v = v.replace(/(\d{2})(\d)/,'($1) $2');
  v = v.replace(/(\d{5})(\d{1,4})$/,'$1-$2');
  el.value = v;
}

// ‚ïê‚ïê‚ïê CEP AUTOM√ÅTICO ‚ïê‚ïê‚ïê
async function mascaraEBuscaCEP(el) {
  let v = el.value.replace(/\D/g,'');
  v = v.replace(/(\d{5})(\d)/,'$1-$2');
  el.value = v;
  const digits = v.replace(/\D/g,'');
  if (digits.length === 8) {
    const s = document.getElementById('cepStatus');
    if(s) s.textContent = '‚è≥';
    try {
      const r = await fetch('https://viacep.com.br/ws/' + digits + '/json/');
      const d = await r.json();
      if (d.erro) { if(s) s.textContent='‚ùå'; setTimeout(()=>{if(s)s.textContent='';},2000); return; }
      document.getElementById('psiRua').value    = d.logradouro || '';
      document.getElementById('psiBairro').value = d.bairro     || '';
      document.getElementById('psiCidade').value = d.localidade || '';
      document.getElementById('psiUF').value     = d.uf         || '';
      if(s) { s.textContent='‚úì'; setTimeout(()=>{if(s)s.textContent='';},3000); }
      document.getElementById('psiNumero').focus();
    } catch(e) { const s=document.getElementById('cepStatus'); if(s){s.textContent='‚ùå';setTimeout(()=>{s.textContent='';},2000);} }
  }
}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('bloco_qtd')?.addEventListener('change', () => { renderBlocoSlots(); calcularBloco(); });
  // Enter no campo de token
  document.getElementById('veriToken')?.addEventListener('keypress', e => { if(e.key==='Enter') validarToken(); });
  // Enter no campo de email
  document.getElementById('veriEmail')?.addEventListener('keypress', e => { if(e.key==='Enter') enviarToken(); });
});
</script>
</body>
</html>
